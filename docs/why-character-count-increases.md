# 所持キャラ数が増える要因

「所持キャラ数が増えた」と感じる場合、以下のような原因が考えられます。

---

## 1. ガチャの二重実行（複数タブ・二重クリック）

**どこで**: 通常ガチャ・プレミアムガチャ・イベントガチャ

**原因**:
- 同じガチャを2回連続で引いた（ボタン二重クリックなど）
- **複数タブ**で同じガチャページを開き、両方で引いた
- 通信が遅い中で「引く」を複数回押した

**対策**:
- **単一タブ制限**（`SingleTabGuard`）を導入済み → 複数タブでの同時プレイは防止
- ガチャボタンは「回転中は無効化」されているが、通信完了前に再度押すと理論上は二重付与の可能性あり

---

## 2. トップページの「初期付与・オーナー特典」の重複実行

**どこで**: トップページ（`app/page.tsx`）の `useEffect` 内

**原因**:
- **初期キャラ付与**（smile, zerom, shunkoro）: 「既にキャラが1体でもいればスキップ」だが、**2タブ同時に開いた**場合、両方とも「0体」と判定して両方で insert する可能性（レースコンディション）
- **オーナー特典**（Lv500 STARY 3体）: 「STARY が 3体未満なら 3−現在数 を追加」だが、**同時に2回実行**されると、両方とも「0体」と見えて最大6体付与される可能性

**対策**:
- 単一タブにしたことで、トップを同時に2回読み込むケースは減っている
- 根本対策としては、DB側で「このユーザーは初期付与済み」「オーナー特典付与済み」を1レコードで管理し、insert 前に select for update や unique 制約で排他する方法がある

---

## 3. Riemu イベント報酬の二重付与

**どこで**:  
- バトル勝利時（`app/adventure/battle/page.tsx`）でステージ3001〜3006クリア時にキャラ付与  
- イベントページ（`app/adventure/riemu-event/page.tsx`）の「復旧処理」で 3006 クリア済みなのに HST riemu がいない場合に付与

**原因**:
- **勝利処理（handleVictory）が2回走った**  
  - `setBattleResult('victory')` や `setIsProcessingVictory(true)` は非同期のため、一瞬のうちに2回 handleVictory が呼ばれると、両方とも「未処理」と判断して報酬を2回 insert する可能性がある
- イベントページの復旧は「HST riemu がいないときだけ insert」なので、通常は1回だけ。ただし **riemu_event_clears に重複で同じステージが入っている**と、別経路で「クリア済み」と見なされ重複付与につながる可能性は低いがゼロではない

**対策**:
- 勝利処理の重複防止を **ref** で行う（`victoryProcessedRef.current` を最初に true にして、先頭で return）とより安全
- Riemu 報酬の insert 前に「同じ name + rarity のキャラが既にいるか」を再度確認する二重チェックも有効

---

## 4. その他（意図した増加）

- **管理者による付与**（`admin/distribute-hst` など）でキャラを配布した
- **ミッション報酬**で経験値は増えるが、キャラの「新規追加」は行っていない（所持数は増えない）
- **合成**で素材を消費すると所持数は減る

---

## まとめ

| 要因               | 可能性 | 備考 |
|--------------------|--------|------|
| ガチャの二重実行   | 高     | 複数タブは単一タブ制限で抑制済み。二重クリックは UI で可能な限り無効化 |
| 初期・オーナー重複 | 中     | 複数タブ・同時読み込みで発生しうる。単一タブで軽減 |
| 勝利報酬の二重付与 | 中     | handleVictory の完全な排他（ref）でさらに防止可能 |
| 管理者付与        | 意図的 | 運用で増えた場合は想定内 |

「増えた」と報告があった場合は、  
- どのユーザーか  
- どのキャラが何体増えたか（名前・レアリティ）  
- いつ頃から増えているか  

が分かると、上記のどれに近いか切り分けしやすくなります。
